<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Feeder - Устройство</title>
  <link rel="stylesheet" href="./assets/styles.css?v=20260226-ru2" />
</head>
<body>
  <div class="app-layout">
    <div id="sidebarMount"></div>
    <main class="main-content page-fade">
      <nav class="breadcrumb-nav">
        <a href="index.html">Панель</a>
        <span class="sep">/</span>
        <span id="breadcrumbName">Устройство</span>
      </nav>

      <section class="card mb-4 device-hero">
        <div class="device-hero-copy">
          <h1 id="deviceTitle">Устройство</h1>
          <p>Оперативное управление кормушкой, профилями и журналами событий.</p>
          <div id="deviceMeta" class="device-meta-cluster"></div>
        </div>
        <div class="device-hero-actions">
          <a id="securityPageLink" class="btn btn-ghost" href="#">Безопасность</a>
        </div>
        <div class="device-kpi-strip">
          <article class="device-kpi">
            <span>Состояние связи</span>
            <strong id="deviceHealth">Не в сети</strong>
          </article>
          <article class="device-kpi">
            <span>Последний пинг</span>
            <strong id="deviceHeartbeat">никогда</strong>
          </article>
          <article class="device-kpi">
            <span>Сигнал</span>
            <strong id="deviceRssi">Нет данных</strong>
          </article>
          <article class="device-kpi">
            <span>Прошивка</span>
            <strong id="deviceFw">-</strong>
          </article>
        </div>
      </section>

      <div class="grid-2 mb-4">
        <section class="card">
          <div class="card-header-bar">
            <h3>Последний статус</h3>
            <small class="muted">Снимок heartbeat устройства</small>
          </div>
          <pre class="json-view" id="statusJson">{}</pre>
        </section>

        <section class="card">
          <div class="card-header-bar">
            <h3>Быстрая команда</h3>
            <small class="muted">Немедленно отправить ручную выдачу</small>
          </div>
          <form id="feedNowForm" class="row g-2 mb-2">
            <div class="col-sm-8">
              <input type="number" name="portionMs" min="1" class="form-control" placeholder="Порция в мс (необязательно)" />
            </div>
            <div class="col-sm-4">
              <button class="btn btn-brand w-100" type="submit">Выдать сейчас</button>
            </div>
          </form>
          <p class="schedule-note">Если значение пустое, используется `defaultPortionMs` активного профиля.</p>
        </section>
      </div>

      <div class="grid-2 mb-4">
        <section class="card">
          <div class="card-header-bar">
            <h3>Профили</h3>
          </div>

          <div class="mb-3">
            <label class="form-label">Активный профиль</label>
            <div class="input-group">
              <select id="activeProfileSelect" class="form-select"></select>
              <button id="activeProfileSave" class="btn btn-ghost" type="button">Применить</button>
            </div>
          </div>

          <form id="createProfileForm" class="row g-2">
            <div class="col-sm-5">
              <input name="name" class="form-control" placeholder="Название профиля" required />
            </div>
            <div class="col-sm-4">
              <input name="defaultPortionMs" type="number" min="1" class="form-control" placeholder="Порция (мс)" required />
            </div>
            <div class="col-sm-3">
              <button class="btn btn-brand w-100" type="submit">Добавить</button>
            </div>
          </form>

          <div class="table-responsive mt-3">
            <table class="table">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Порция</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="profileRows"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="card-header-bar">
            <h3>Расписание (активный профиль)</h3>
            <small class="muted">Формат 24ч</small>
          </div>

          <div id="scheduleEditor"></div>
          <div class="mt-3 d-flex gap-2">
            <button id="addScheduleRow" type="button" class="btn btn-ghost">+ Событие</button>
            <button id="saveSchedule" type="button" class="btn btn-brand">Сохранить расписание</button>
          </div>
        </section>
      </div>

      <section class="card">
        <div class="card-header-bar">
          <h3>Журнал событий</h3>
          <small class="muted">До 50 записей на страницу</small>
        </div>

        <form id="logFilterForm" class="row g-2 mb-3">
          <div class="col-sm-3">
            <input name="type" class="form-control" placeholder="Тип (AUTO_FEED...)" />
          </div>
          <div class="col-sm-6">
            <input name="q" class="form-control" placeholder="Поиск по сообщению" />
          </div>
          <div class="col-sm-3">
            <button class="btn btn-ghost w-100" type="submit">Фильтр</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Время</th>
                <th>Тип</th>
                <th>Сообщение</th>
                <th>Мета</th>
              </tr>
            </thead>
            <tbody id="logRows"></tbody>
          </table>
        </div>

        <div class="log-pagination">
          <button id="logsPrev" class="btn btn-sm btn-ghost" type="button">Назад</button>
          <button id="logsNext" class="btn btn-sm btn-ghost" type="button">Вперёд</button>
        </div>
      </section>
    </main>
  </div>

  <script src="./assets/app.js?v=20260226-ru2"></script>
  <script>
    const deviceId = sfApi.qp('id');
    if (!deviceId) {
      sfApi.toast('Не указан ID устройства', 'error');
      location.href = 'index.html';
    }

    document.getElementById('securityPageLink').href = `security.html?id=${encodeURIComponent(deviceId)}`;

    let currentDetails = null;
    let selectedProfileId = null;
    let scheduleRows = [];
    let logsPage = 0;
    let devices = [];
    let currentUser = null;

    async function init() {
      try {
        currentUser = await sfApi.me();
      } catch {
        location.href = 'index.html';
        return;
      }

      try {
        devices = await sfApi.listDevices();
      } catch {
        devices = [];
      }

      await loadDevice();
    }

    function renderSidebarNow() {
      document.getElementById('sidebarMount').innerHTML = sfApi.renderSidebar({
        activePage: 'device',
        devices,
        currentDeviceId: deviceId,
        userEmail: currentUser ? currentUser.email : ''
      });
    }

    function renderScheduleEditor() {
      const root = document.getElementById('scheduleEditor');
      if (!scheduleRows.length) {
        root.innerHTML = '<p class="muted">Событий расписания пока нет.</p>';
        return;
      }

      root.innerHTML = scheduleRows.map((row, idx) => `
        <div class="schedule-row" data-row="${idx}">
          <div>
            <small>HH</small>
            <input class="form-control" data-k="hh" type="number" min="0" max="23" value="${row.hh}">
          </div>
          <div>
            <small>MM</small>
            <input class="form-control" data-k="mm" type="number" min="0" max="59" value="${row.mm}">
          </div>
          <div>
            <small>Порция мс</small>
            <input class="form-control" data-k="portionMs" type="number" min="1" value="${row.portionMs}">
          </div>
          <div>
            <small>Удалить</small>
            <button class="btn btn-outline-danger w-100 schedule-remove" data-del="${idx}">&times;</button>
          </div>
        </div>
      `).join('');

      root.querySelectorAll('input').forEach((input) => {
        input.addEventListener('input', (e) => {
          const row = Number(e.target.closest('[data-row]').dataset.row);
          const key = e.target.dataset.k;
          scheduleRows[row][key] = Number(e.target.value || 0);
        });
      });

      root.querySelectorAll('button[data-del]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          scheduleRows.splice(Number(btn.dataset.del), 1);
          renderScheduleEditor();
        });
      });
    }

    function renderProfiles() {
      const select = document.getElementById('activeProfileSelect');
      const rows = document.getElementById('profileRows');
      const profiles = currentDetails.profiles || [];

      select.innerHTML = profiles
        .map((p) => `<option value="${p.name}" ${p.name === currentDetails.activeProfile ? 'selected' : ''}>${p.name}</option>`)
        .join('');

      rows.innerHTML = profiles.map((p) => `
        <tr>
          <td>${p.name}</td>
          <td>${p.defaultPortionMs} ms</td>
          <td>
            <button class="btn btn-sm btn-ghost" data-edit="${p.id}" data-name="${p.name}" data-portion="${p.defaultPortionMs}">Изменить</button>
            <button class="btn btn-sm btn-outline-danger" data-del="${p.id}">Удалить</button>
          </td>
        </tr>
      `).join('');

      rows.querySelectorAll('button[data-del]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!confirm('Удалить этот профиль?')) return;
          try {
            await sfApi.deleteProfile(btn.dataset.del);
            sfApi.toast('Профиль удален', 'success');
            await loadDevice();
          } catch (err) {
            sfApi.toast(err.message, 'error');
          }
        });
      });

      rows.querySelectorAll('button[data-edit]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const newName = prompt('Новое название профиля', btn.dataset.name);
          if (!newName) return;
          const newPortionRaw = prompt('Новая порция по умолчанию (мс)', btn.dataset.portion);
          if (!newPortionRaw) return;
          const newPortion = Number(newPortionRaw);
          if (!Number.isFinite(newPortion) || newPortion <= 0) {
            sfApi.toast('Некорректное значение порции', 'error');
            return;
          }
          try {
            await sfApi.updateProfile(btn.dataset.edit, { name: newName, defaultPortionMs: newPortion });
            sfApi.toast('Профиль обновлен', 'success');
            await loadDevice();
          } catch (err) {
            sfApi.toast(err.message, 'error');
          }
        });
      });

      const activeProfile = profiles.find((p) => p.name === currentDetails.activeProfile) || profiles[0];
      selectedProfileId = activeProfile ? activeProfile.id : null;

      scheduleRows = (currentDetails.schedule || [])
        .filter((s) => activeProfile && s.profileName === activeProfile.name)
        .map((s) => ({ hh: s.hh, mm: s.mm, portionMs: s.portionMs }));

      renderScheduleEditor();
    }

    async function loadDevice() {
      currentDetails = await sfApi.getDevice(deviceId);
      renderSidebarNow();

      document.getElementById('deviceTitle').textContent = currentDetails.name;
      document.getElementById('breadcrumbName').textContent = currentDetails.name;
      document.getElementById('statusJson').textContent = JSON.stringify(currentDetails.status || {}, null, 2);

      document.getElementById('deviceMeta').innerHTML = `
        ${sfApi.onlineBadge(currentDetails.lastSeenAt)}
        <span class="meta-pill">Последняя связь: ${sfApi.fmtTs(currentDetails.lastSeenAt)}</span>
        <span class="meta-pill">Относительно: ${sfApi.relativeTime(currentDetails.lastSeenAt)}</span>
        <span class="meta-pill">Активный профиль: ${currentDetails.activeProfile || '—'}</span>
      `;

      const lastStatus = currentDetails.status || {};
      const rssiText = typeof lastStatus.rssi === 'number' ? `${lastStatus.rssi} dBm` : 'Нет данных';

      document.getElementById('deviceHealth').textContent = sfApi.isOnline(currentDetails.lastSeenAt) ? 'В сети' : 'Не в сети';
      document.getElementById('deviceHeartbeat').textContent = sfApi.relativeTime(currentDetails.lastSeenAt);
      document.getElementById('deviceRssi').textContent = rssiText;
      document.getElementById('deviceFw').textContent = currentDetails.firmwareVersion || lastStatus.fw || '-';

      renderProfiles();
      await loadLogs();
    }

    async function loadLogs() {
      const filterFd = new FormData(document.getElementById('logFilterForm'));
      const logs = await sfApi.listLogs(deviceId, filterFd.get('type'), filterFd.get('q'), logsPage, 50);
      const body = document.getElementById('logRows');

      if (!logs.length) {
        body.innerHTML = '<tr><td colspan="4" class="muted">Логи не найдены</td></tr>';
        return;
      }

      body.innerHTML = logs.map((l) => `
        <tr>
          <td style="white-space:nowrap">${sfApi.fmtTs(l.ts)}</td>
          <td>${l.type}</td>
          <td>${l.message}</td>
          <td><code>${JSON.stringify(l.meta)}</code></td>
        </tr>
      `).join('');
    }

    document.getElementById('activeProfileSave').addEventListener('click', async () => {
      const profileName = document.getElementById('activeProfileSelect').value;
      try {
        await sfApi.setActiveProfile(deviceId, profileName);
        sfApi.toast('Активный профиль обновлен', 'success');
        await loadDevice();
      } catch (err) {
        sfApi.toast(err.message, 'error');
      }
    });

    document.getElementById('createProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type=submit]');
      sfApi.showLoading(btn, 'Добавляем...');
      try {
        await sfApi.createProfile(deviceId, fd.get('name'), Number(fd.get('defaultPortionMs')));
        e.target.reset();
        sfApi.toast('Профиль создан', 'success');
        await loadDevice();
      } catch (err) {
        sfApi.toast(err.message, 'error');
      } finally {
        sfApi.hideLoading(btn);
      }
    });

    document.getElementById('addScheduleRow').addEventListener('click', () => {
      scheduleRows.push({ hh: 8, mm: 0, portionMs: 1000 });
      renderScheduleEditor();
    });

    document.getElementById('saveSchedule').addEventListener('click', async () => {
      if (!selectedProfileId) {
        sfApi.toast('Профиль не выбран', 'warning');
        return;
      }

      const btn = document.getElementById('saveSchedule');
      sfApi.showLoading(btn, 'Сохраняем...');
      try {
        await sfApi.replaceSchedule(selectedProfileId, scheduleRows);
        sfApi.toast('Расписание сохранено', 'success');
        await loadDevice();
      } catch (err) {
        sfApi.toast(err.message, 'error');
      } finally {
        sfApi.hideLoading(btn);
      }
    });

    document.getElementById('feedNowForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const portionVal = fd.get('portionMs');
      const btn = e.target.querySelector('button[type=submit]');
      sfApi.showLoading(btn, 'Отправляем...');
      try {
        await sfApi.feedNow(deviceId, portionVal ? Number(portionVal) : null);
        sfApi.toast('Команда FEED_NOW поставлена в очередь', 'success');
      } catch (err) {
        sfApi.toast(err.message, 'error');
      } finally {
        sfApi.hideLoading(btn);
      }
    });

    document.getElementById('logFilterForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      logsPage = 0;
      await loadLogs();
    });

    document.getElementById('logsPrev').addEventListener('click', async () => {
      logsPage = Math.max(0, logsPage - 1);
      await loadLogs();
    });

    document.getElementById('logsNext').addEventListener('click', async () => {
      logsPage += 1;
      await loadLogs();
    });

    init();
  </script>
</body>
</html>
