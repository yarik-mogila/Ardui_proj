<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Feeder - Безопасность</title>
  <link rel="stylesheet" href="./assets/styles.css?v=20260226-ru2" />
</head>
<body>
  <div class="app-layout">
    <div id="sidebarMount"></div>
    <main class="main-content page-fade">

      <nav class="breadcrumb-nav">
        <a href="index.html">Панель</a>
        <span class="sep">/</span>
        <a id="deviceLink" href="#">Устройство</a>
        <span class="sep">/</span>
        <span>Безопасность</span>
      </nav>

      <div class="page-header">
        <h1 id="title">Безопасность</h1>
        <p id="meta"></p>
      </div>

      <section class="card security-overview mb-4">
        <div>
          <h3>Режим авторизации устройства</h3>
          <p class="muted" style="margin-top:8px">
            Подпись устройства и защита от повторов управляются одним глобальным флагом сервера.
          </p>
          <div id="signState"></div>
        </div>
        <div class="security-overview-side">
          <article class="security-flag">
            <span>Защита от повтора nonce</span>
            <strong id="nonceState">ОБХОД</strong>
          </article>
          <article class="security-flag">
            <span>Проверка HMAC</span>
            <strong id="hmacState">ОБХОД</strong>
          </article>
          <article class="security-flag">
            <span>Область действия</span>
            <strong>Все устройства</strong>
          </article>
        </div>
      </section>

      <div class="grid-2 mb-4">
        <section class="card">
          <h3>Предупреждения</h3>
          <div id="warnBox" style="margin-top:12px"></div>
        </section>
        <section class="card">
          <h3>Рекомендации</h3>
          <ul class="security-list">
            <li>После смены секрета старое значение перестает работать немедленно.</li>
            <li>Новый секрет показывается только один раз в интерфейсе.</li>
            <li>После смены секрета обновите прошивку устройства без задержек.</li>
          </ul>
        </section>
      </div>

      <div class="danger-zone">
        <h3>Смена секрета</h3>
        <p class="muted">После смены старый секрет перестанет работать сразу. Обновите секрет в прошивке устройства.</p>
        <button id="rotateBtn" class="btn btn-outline-danger">Сменить секрет</button>
        <div id="rotateResult" class="mt-3"></div>
      </div>

    </main>
  </div>

  <script src="./assets/app.js?v=20260226-ru2"></script>
  <script>
    const deviceId = sfApi.qp('id');
    if (!deviceId) {
      sfApi.toast('Не указан ID устройства', 'error');
      location.href = 'index.html';
    }
    document.getElementById('deviceLink').href = `device.html?id=${encodeURIComponent(deviceId)}`;

    let devices = [];
    let currentUser = null;

    async function init() {
      try {
        currentUser = await sfApi.me();
      } catch {
        location.href = 'index.html';
        return;
      }
      try {
        devices = await sfApi.listDevices();
      } catch { devices = []; }
      renderSidebarNow();
      await load();
    }

    function renderSidebarNow() {
      document.getElementById('sidebarMount').innerHTML = sfApi.renderSidebar({
        activePage: 'security',
        devices: devices,
        currentDeviceId: deviceId,
        userEmail: currentUser ? currentUser.email : ''
      });
    }

    async function load() {
      const [details, sec] = await Promise.all([
        sfApi.getDevice(deviceId),
        sfApi.securityConfig()
      ]);

      document.getElementById('title').textContent = `Безопасность: ${details.name}`;
      document.getElementById('deviceLink').textContent = details.name;
      document.getElementById('meta').innerHTML = `${sfApi.onlineBadge(details.lastSeenAt)} <span class="meta-pill">Последняя связь: ${sfApi.fmtTs(details.lastSeenAt)}</span>`;

      document.getElementById('signState').innerHTML = sec.signatureEnabled
        ? '<div class="security-state security-state-on"><strong>Подпись включена.</strong> Проверка HMAC и защита от повторов nonce активны.</div>'
        : '<div class="security-state security-state-off"><strong>Подпись выключена.</strong> Проверки HMAC и nonce обходятся глобальным флагом сервера.</div>';
      document.getElementById('nonceState').textContent = sec.signatureEnabled ? 'ВКЛЮЧЕНО' : 'ОБХОД';
      document.getElementById('hmacState').textContent = sec.signatureEnabled ? 'ВКЛЮЧЕНО' : 'ОБХОД';

      const offline = !details.lastSeenAt || (Date.now() - new Date(details.lastSeenAt).getTime() > 120000);
      document.getElementById('warnBox').innerHTML = offline
        ? '<div class="warn-box">Устройство не выходило на связь более 2 минут.</div>'
        : '<div class="ok-box">Устройство в сети, heartbeat стабильный.</div>';
    }

    document.getElementById('rotateBtn').addEventListener('click', async () => {
      if (!confirm('Сменить секрет сейчас? Старый секрет перестанет работать сразу.')) return;
      const btn = document.getElementById('rotateBtn');
      sfApi.showLoading(btn, 'Смена...');
      try {
        const res = await sfApi.rotateSecret(deviceId);
        document.getElementById('rotateResult').innerHTML =
          `<div class="warn-box"><strong>Новый секрет:</strong> <code>${res.secret}</code><div class="muted" style="margin-top:6px">Сохраните сейчас, значение показывается один раз.</div></div>`;
        sfApi.toast('Секрет обновлен', 'success');
      } catch (err) {
        sfApi.toast(err.message, 'error');
      } finally {
        sfApi.hideLoading(btn);
      }
    });

    init();
  </script>
</body>
</html>
