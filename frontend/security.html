<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Feeder Security</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <div class="app-layout">
    <div id="sidebarMount"></div>
    <main class="main-content page-fade">

      <nav class="breadcrumb-nav">
        <a href="/index.html">Dashboard</a>
        <span class="sep">/</span>
        <a id="deviceLink" href="#">Device</a>
        <span class="sep">/</span>
        <span>Security</span>
      </nav>

      <div class="page-header">
        <h1 id="title">Security</h1>
        <p id="meta"></p>
      </div>

      <section class="card security-overview mb-4">
        <div>
          <h3>Device auth mode</h3>
          <p class="muted" style="margin-top:8px">
            Подпись устройства и replay-защита управляются одним глобальным флагом сервера.
          </p>
          <div id="signState"></div>
        </div>
        <div class="security-overview-side">
          <article class="security-flag">
            <span>Nonce replay guard</span>
            <strong id="nonceState">BYPASSED</strong>
          </article>
          <article class="security-flag">
            <span>HMAC pipeline</span>
            <strong id="hmacState">BYPASSED</strong>
          </article>
          <article class="security-flag">
            <span>Applied scope</span>
            <strong>All devices</strong>
          </article>
        </div>
      </section>

      <div class="grid-2 mb-4">
        <section class="card">
          <h3>Runtime warnings</h3>
          <div id="warnBox" style="margin-top:12px"></div>
        </section>
        <section class="card">
          <h3>Operational notes</h3>
          <ul class="security-list">
            <li>При rotate старый secret перестает работать немедленно.</li>
            <li>Новый secret показывается только один раз в интерфейсе.</li>
            <li>После смены секрета обновите прошивку устройства без задержек.</li>
          </ul>
        </section>
      </div>

      <div class="danger-zone">
        <h3>Rotate secret</h3>
        <p class="muted">After rotation the old secret will stop working immediately. Make sure to update the device firmware.</p>
        <button id="rotateBtn" class="btn btn-outline-danger">Rotate secret now</button>
        <div id="rotateResult" class="mt-3"></div>
      </div>

    </main>
  </div>

  <script src="/assets/app.js"></script>
  <script>
    const deviceId = sfApi.qp('id');
    if (!deviceId) {
      sfApi.toast('Missing device ID', 'error');
      location.href = '/index.html';
    }
    document.getElementById('deviceLink').href = `/device.html?id=${encodeURIComponent(deviceId)}`;

    let devices = [];
    let currentUser = null;

    async function init() {
      try {
        currentUser = await sfApi.me();
      } catch {
        location.href = '/index.html';
        return;
      }
      try {
        devices = await sfApi.listDevices();
      } catch { devices = []; }
      renderSidebarNow();
      await load();
    }

    function renderSidebarNow() {
      document.getElementById('sidebarMount').innerHTML = sfApi.renderSidebar({
        activePage: 'security',
        devices: devices,
        currentDeviceId: deviceId,
        userEmail: currentUser ? currentUser.email : ''
      });
    }

    async function load() {
      const [details, sec] = await Promise.all([
        sfApi.getDevice(deviceId),
        sfApi.securityConfig()
      ]);

      document.getElementById('title').textContent = `Security: ${details.name}`;
      document.getElementById('deviceLink').textContent = details.name;
      document.getElementById('meta').innerHTML = `${sfApi.onlineBadge(details.lastSeenAt)} <span class="meta-pill">Last seen: ${sfApi.fmtTs(details.lastSeenAt)}</span>`;

      document.getElementById('signState').innerHTML = sec.signatureEnabled
        ? '<div class="security-state security-state-on"><strong>Signature enabled.</strong> HMAC verification and nonce replay protection are active.</div>'
        : '<div class="security-state security-state-off"><strong>Signature disabled.</strong> HMAC and nonce checks are bypassed by global server flag.</div>';
      document.getElementById('nonceState').textContent = sec.signatureEnabled ? 'ENABLED' : 'BYPASSED';
      document.getElementById('hmacState').textContent = sec.signatureEnabled ? 'ENABLED' : 'BYPASSED';

      const offline = !details.lastSeenAt || (Date.now() - new Date(details.lastSeenAt).getTime() > 120000);
      document.getElementById('warnBox').innerHTML = offline
        ? '<div class="warn-box">Device has been offline for more than 2 minutes.</div>'
        : '<div class="ok-box">Device heartbeat is healthy and currently online.</div>';
    }

    document.getElementById('rotateBtn').addEventListener('click', async () => {
      if (!confirm('Rotate secret now? The old secret will stop working immediately.')) return;
      const btn = document.getElementById('rotateBtn');
      sfApi.showLoading(btn, 'Rotating...');
      try {
        const res = await sfApi.rotateSecret(deviceId);
        document.getElementById('rotateResult').innerHTML =
          `<div class="warn-box"><strong>New secret:</strong> <code>${res.secret}</code><div class="muted" style="margin-top:6px">Save it now. This value is shown only once.</div></div>`;
        sfApi.toast('Secret rotated', 'success');
      } catch (err) {
        sfApi.toast(err.message, 'error');
      } finally {
        sfApi.hideLoading(btn);
      }
    });

    init();
  </script>
</body>
</html>
